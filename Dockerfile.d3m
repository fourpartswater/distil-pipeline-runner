ARG VERSION=latest
FROM docker.uncharted.software/distil-pipeline-runner-env:$VERSION

RUN pip3 install https://github.com/explosion/spacy-models/releases/download/en_core_web_md-2.0.0/en_core_web_md-2.0.0.tar.gz

# Using the requirements file results in a single cache layer for python packages and
# dependencies, which makes the image build very slowly when a new python package is added.
# As an optimization, we intentionally run package installation as a manual set of RUN
# commands, and ignore the requirements.txt file.  We could template this Dockerfile
# and have the build.sh script copy the contents of the requirements file in to reduce
# duplication.
#
# COPY requirements.txt ./requirements.txt
# RUN pip3 install -r requirements.txt --process-dependency-links

# D3M baseline packages - do this first because there are a lot of dependencies.
# Common primitives has a lot of dependencies that aren't used, so we stop transitive resolution.  Torch is
# the only that is required due to its use in a shared utilities function.
RUN pip3 install -e git+https://gitlab.com/datadrivendiscovery/common-primitives.git#egg=common_primitives --process-dependency-links --no-deps
RUN pip3 install torch==1.0.0
RUN pip3 install -e git+https://gitlab.com/datadrivendiscovery/ta3ta2-api@dev-dist-python#egg=ta3ta2_utils --process-dependency-links

# NK Primitives
RUN pip3 install -e git+https://github.com/NewKnowledge/croc-d3m-wrapper.git@#egg=CrocD3MWrapper --process-dependency-links
RUN pip3 install -e git+https://github.com/NewKnowledge/pcafeatures-d3m-wrapper.git@768bedb72eafd7f4e7edb2913fa149da24592504#egg=PcafeaturesD3MWrapper --process-dependency-links
RUN pip3 install -e git+https://github.com/cdbethune/simon-d3m-wrapper.git@90e49da54a8a63917b5ee65962022b80007438ed#egg=SimonD3MWrapper --process-dependency-links
RUN pip3 install -e git+https://github.com/cdbethune/duke-d3m-wrapper.git@047185379a70973cc04f0bb5cce39eb3fb8b297f#egg=DukeD3MWrapper --process-dependency-links
RUN pip3 install -e git+https://github.com/NewKnowledge/unicorn-d3m-wrapper.git@2c9bacb40f987f692ada5f0f12b9b56261be70fa#egg=UnicornD3MWrapper --process-dependency-links
RUN pip3 install -e git+https://github.com/cdbethune/sloth-d3m-wrapper.git@d0c1868b96651013e6f49696331d8800d79d85a9#egg=SlothD3MWrapper --process-dependency-links
RUN pip3 install -e git+https://github.com/NewKnowledge/goat-d3m-wrapper.git@a12e6ba6c0b4d6a05fd2a5fc93f4fa28851d5b78#egg=GoatD3MWrapper --process-dependency-links
RUN pip3 install -e git+https://github.com/cdbethune/datacleaning-d3m-wrapper.git@f5e06b7fc0f16deba6b7debb53beee6f9f2d0efa#egg=DataCleaningD3MWrapper --process-dependency-links
